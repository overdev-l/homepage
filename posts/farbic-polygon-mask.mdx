---
title: æ•°æ®æ ‡æ³¨å¹³å°ä¸­åŸºäºFabric.jså®ç°é«˜æ•ˆå¤šè¾¹å½¢æ ‡æ³¨maskåŠŸèƒ½çš„å®Œæ•´æŒ‡å—
date: 2025-03-12
description: æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•åœ¨æ•°æ®æ ‡æ³¨å¹³å°ä¸­åŸºäºFabric.jså®ç°é«˜æ•ˆå¤šè¾¹å½¢maskæ ‡æ³¨åŠŸèƒ½ï¼ŒåŒ…å«å®Œæ•´ä»£ç ç¤ºä¾‹ã€æ€§èƒ½ä¼˜åŒ–æŠ€å·§å’Œç”¨æˆ·ä½“éªŒè®¾è®¡ï¼ŒåŠ©åŠ›AIè®­ç»ƒæ•°æ®ç²¾å‡†æ ‡æ³¨ã€‚
---

*å…ˆçœ‹DemoğŸ‘‡ï¼š*
<FabricPolygonMask/>

## æ ¸å¿ƒåŠŸèƒ½
1. **å¤šè¾¹å½¢ç»˜åˆ¶**
   - é¼ æ ‡ç‚¹å‡»ç»˜åˆ¶é¡¶ç‚¹
   - å®æ—¶é¢„è§ˆç»˜åˆ¶è·¯å¾„
   - ç©ºæ ¼é”®æäº¤å¤šè¾¹å½¢
   - æ”¯æŒè¦†ç›–æ¨¡å¼/åˆå¹¶æ¨¡å¼åˆ‡æ¢

2. **å¤šè¾¹å½¢ç¼–è¾‘**
   - æ§åˆ¶ç‚¹æ‹–æ‹½ä¿®æ”¹å½¢çŠ¶
   - è‡ªåŠ¨ç»´æŠ¤å¤šè¾¹å½¢æ‹“æ‰‘å…³ç³»
   - æ”¯æŒå¤šå›¾å±‚å åŠ æ¸²æŸ“

3. **é«˜çº§ç‰¹æ€§**
   - å¤šè¾¹å½¢å¸ƒå°”è¿ç®—åˆå¹¶

---
æŠ€æœ¯å®ç°ä»¥æ’ä»¶æ–¹å¼å¼•å…¥åªéœ€è¦ä¼ é€’`fabric.Canvas`å®ä¾‹å³å¯
```ts
new PolygonUtil(fabricCanvas.current)
```
`polygonUtil`ä½œä¸ºæ ¸å¿ƒå·¥å…·æ’ä»¶ï¼Œåè°ƒè§†å›¾å·¥å…·å’Œå­˜å‚¨ç®¡ç†ã€‚

æ ¸å¿ƒå·¥å…·æ’ä»¶ä»¥Viewã€Stashã€Themeã€ä»¥åŠPolyboolç»„æˆï¼Œå¯¹å¤–æš´éœ²ä»¥ä¸Šæ’ä»¶çš„æ•´åˆï¼Œä½†æ˜¯ä¸ä¿å­˜ä»»ä½•çŠ¶æ€ï¼Œåªåšèšåˆèƒ½åŠ›ã€‚


### ViewğŸ‘€

<PlyrVideo src="https://cdn.overdev.cn/View.mp4" id="view-video" />


Viewæ¨¡å—ç»´æŠ¤äº†åˆ›å»ºæ—¶çš„ä¸´æ—¶å¤šè¾¹å½¢çš„æ¸²æŸ“å’Œæäº¤åˆ›å»ºå®Œæˆçš„å¤šè¾¹å½¢èƒ½åŠ›ã€‚ä¸‹é¢ä»£ç æè¿°äº†ä»¥`Fabric`äº‹ä»¶é©±åŠ¨çš„å®æ—¶æ›´æ–°ä¸´æ—¶å¤šè¾¹å½¢çš„é€»è¾‘
- onMouseDown(e): è®°å½•é¼ æ ‡ç‚¹å‡»çš„ä½ç½®ï¼Œå¹¶å°†å…¶å­˜å…¥ pointers æ•°ç»„ã€‚
- onMouseMove(e): å½“é¼ æ ‡ç§»åŠ¨æ—¶ï¼Œå¦‚æœå·²æœ‰ç‚¹å‡»ç‚¹ï¼Œåˆ™æ›´æ–° lastPointerï¼Œç”¨äºåŠ¨æ€é¢„è§ˆå¤šè¾¹å½¢ã€‚
- render(): æ¸…é™¤æ—§çš„é¢„è§ˆåï¼Œä½¿ç”¨ pointers å’Œ lastPointer ç”Ÿæˆæ–°çš„ Polygon å¹¶æ¸²æŸ“åˆ°ç”»å¸ƒä¸Šã€‚

æ•´ä½“ä½œç”¨æ˜¯æ ¹æ®ç”¨æˆ·çš„é¼ æ ‡ç‚¹å‡»å’Œç§»åŠ¨åŠ¨æ€ç»˜åˆ¶å¤šè¾¹å½¢é¢„è§ˆã€‚
```ts
export class ViewTool {
    ...
    
    onMouseDown(e: TPointerEventInfo<TPointerEvent>) {
        if (!this.isEnable) return;
        const pointer = this.polygonUtil
                            .canvas
                            .getScenePoint(e.e);
        this.pointers.push(pointer);
        this.render();
    }

    onMouseMove(e: TPointerEventInfo<TPointerEvent>) {
        if (
            !this.isEnable ||
            this.pointers.length === 0
            ) return;
        this.lastPointer = this.polygonUtil
                               .canvas
                               .getScenePoint(e.e);
        this.render();
    }

    private render() {
        this.clearPreview();
        this.polygonView = new Polygon(
            [...this.pointers, this.lastPointer],
            {
            fill: this.polygonUtil
                      .theme
                      .getPolygonViewTheme().fill,
            stroke: this.polygonUtil
                        .theme
                        .getPolygonViewTheme().stroke
        });
        this.polygonView.set({ name: 'view-polygon' });
        this.polygonUtil.canvas.add(this.polygonView);
    }
}
```

### StashğŸ’¾

ä»Viewä¸­çš„è§†é¢‘å¯ä»¥çœ‹åˆ°ï¼Œå½“ç”¨æˆ·ç‚¹å‡»é¼ æ ‡ç»˜åˆ¶å¤šè¾¹å½¢æ—¶ï¼Œ
ä¼šå®æ—¶æ›´æ–°å¤šè¾¹å½¢çš„é¢„è§ˆï¼Œå½“ç”¨æˆ·æŒ‰ä¸‹ç©ºæ ¼é”®æ—¶ï¼Œä¼šæäº¤å¤šè¾¹å½¢ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªPolygonå¯¹è±¡ï¼Œç„¶åå°†å…¶å­˜å‚¨åˆ°Stashä¸­ã€‚

Stashæ¨¡å—è´Ÿè´£å­˜å‚¨å’Œç®¡ç†å¤šè¾¹å½¢æ•°æ®ï¼Œå¹¶è´Ÿè´£ç®¡ç†å·²ç»æäº¤çš„å¤šè¾¹å‹çš„ä¿®æ”¹ã€‚

<PlyrVideo src="https://cdn.overdev.cn/Stash.mp4" id="stash-video" />

Stash ç±»ç”¨äºç®¡ç†å¤šè¾¹å½¢çš„åˆ›å»ºã€æ¸²æŸ“å’Œäº¤äº’æ“ä½œï¼Œä¾èµ– PolygonUtil è¿›è¡Œç»˜åˆ¶ï¼Œå¹¶ç›‘å¬ Fabric.js ç”»å¸ƒä¸Šçš„å¯¹è±¡ç§»åŠ¨äº‹ä»¶ï¼Œä»¥åŠ¨æ€æ›´æ–°å¤šè¾¹å½¢çš„é¡¶ç‚¹ä½ç½®ã€‚
1. åˆå§‹åŒ– (constructor)
- é€šè¿‡ PolygonUtil ç®¡ç† Fabric.js ç”»å¸ƒã€‚
- è§£æ defaultPolygonPointerJson ç”Ÿæˆåˆå§‹å¤šè¾¹å½¢ï¼Œå¹¶è°ƒç”¨ addPolygon æ·»åŠ åˆ° polygons åˆ—è¡¨ã€‚
- æ¸²æŸ“æ‰€æœ‰å¤šè¾¹å½¢åŠå…¶æ§åˆ¶ç‚¹ã€‚
- ç›‘å¬ object:moving äº‹ä»¶ï¼Œå®ç°äº¤äº’åŠŸèƒ½ã€‚
2. å¯¹è±¡ç§»åŠ¨ç›‘å¬ (onObjectMoving)
- ç›‘å¬ Fabric.js ç”»å¸ƒä¸­å¯¹è±¡ç§»åŠ¨äº‹ä»¶ã€‚
- å½“æ§åˆ¶ç‚¹ç§»åŠ¨æ—¶ï¼Œæ›´æ–°å…¶å¯¹åº”å¤šè¾¹å½¢çš„ points æ•°æ®ã€‚
- è§¦å‘ Fabric.js é‡æ–°æ¸²æŸ“ï¼Œä¿è¯ç•Œé¢åŒæ­¥æ›´æ–°ã€‚
3. å¤šè¾¹å½¢ç®¡ç†
- addPolygon(polygon: StashPolygon): æ·»åŠ å¤šè¾¹å½¢ï¼Œè‹¥ isCover ä¸º true ç›´æ¥å­˜å…¥ polygonsï¼Œå¦åˆ™åˆå¹¶è‡³å·²æœ‰å¤šè¾¹å½¢ï¼ˆpolygonUnionï¼‰ã€‚
- removeAllPolygonByCanvas(): ç§»é™¤ Fabric.js ç”»å¸ƒä¸Šæ‰€æœ‰å·²å­˜å‚¨çš„å¤šè¾¹å½¢åŠå…¶æ§åˆ¶ç‚¹ã€‚
4. å¤šè¾¹å½¢æ¸²æŸ“
- renderAllPolygon(): éå† polygons æ•°ç»„ï¼Œåœ¨ Fabric.js ç”»å¸ƒä¸Šæ·»åŠ å¯¹åº”çš„ Polygon å¯¹è±¡ã€‚
- renderAllControl(): ä¸ºæ¯ä¸ªå¤šè¾¹å½¢çš„é¡¶ç‚¹æ·»åŠ å¯æ‹–åŠ¨çš„ Circle æ§åˆ¶ç‚¹ï¼Œä»¥æ”¯æŒäº¤äº’è°ƒæ•´ã€‚
- render(): æ¸…ç©ºç”»å¸ƒä¸Šçš„å¤šè¾¹å½¢å’Œæ§åˆ¶ç‚¹ï¼Œå¹¶é‡æ–°æ¸²æŸ“æ‰€æœ‰å†…å®¹ã€‚

```ts
export class Stash {
    public polygons: StashPolygon[] = [];

    constructor(public polygonUtil: PolygonUtil) {
        this.addPolygon({
            points: JSON.parse(defaultPolygonPointerJson).map(({ x, y }) => new Point(x, y)),
            theme: defaultPolygonTheme,
            controlTheme: defaultControlTheme,
            id: nanoid(),
            isCover: false,
        });
        this.render();
        this.polygonUtil.canvas.on('object:moving', this.onObjectMoving.bind(this));
    }

    onObjectMoving(e: BasicTransformEvent<TPointerEvent> & { target: FabricObject }) {
        const { target } = e;
        const polygonId = target.get('polygonId');
        const pointerIndex = target.get('pointerIndex');
        const polygonElement = this.polygonUtil.canvas.getObjects().find(item => item.get('id') === polygonId);
        const polygon = this.polygons.find(item => item.id === polygonId);

        if (polygonId === undefined || pointerIndex === undefined || !polygonElement || !polygon) return;

        polygonElement.get('points')[pointerIndex] = target.getCenterPoint();
        polygonElement.set('points', polygonElement.get('points'));
        this.polygonUtil.canvas.renderAll();
    }

    addPolygon(polygon: StashPolygon) {
        polygon.isCover ? this.polygons.push(polygon) : polygonUnion.call(this, polygon);
    }

    removeAllPolygonByCanvas() {
        const ids = new Set(this.polygons.map(p => p.id));
        this.polygonUtil.canvas.remove(
            ...this.polygonUtil.canvas.getObjects().filter(obj => ids.has(obj.get('id') || obj.get('polygonId')))
        );
    }

    renderAllPolygon() {
        this.polygons.forEach(({ id, points, theme }) => {
            this.polygonUtil.canvas.add(new Polygon(points, {
                ...theme, selectable: false, hasBorders: false, hasControls: false, objectCaching: false, id
            }));
        });
    }

    renderAllControl() {
        this.polygons.forEach(({ id, points, controlTheme }) => {
            points.forEach((point, index) => {
                this.polygonUtil.canvas.add(new Circle({
                    ...controlTheme, originX: 'center', originY: 'center', radius: 3, left: point.x, top: point.y,
                    hasControls: false, hasBorders: false, polygonId: id, pointerIndex: index
                }));
            });
        });
    }

    render() {
        this.removeAllPolygonByCanvas();
        this.renderAllPolygon();
        this.renderAllControl();
    }
}

```

### PolyboolğŸ”„

Polybool ç±»ç”¨äºå¤„ç†å¤šè¾¹å½¢çš„å¸ƒå°”è¿ç®—ï¼ŒåŒ…æ‹¬åˆå¹¶ã€ç›¸äº¤ç­‰æ“ä½œã€‚

<PlyrVideo src="https://cdn.overdev.cn/Poly.mp4" id="polybool-video" />

å½“ç”¨æˆ·å°†Viewä¸­çš„å¤šè¾¹å½¢æäº¤åˆ°Stashä¸­æ—¶ï¼Œä¼šæ£€æµ‹æäº¤çš„å¤šè¾¹å‹æ˜¯å¦ä¸Stashä¸­çš„å¤šè¾¹å½¢å­˜åœ¨é‡å ï¼Œå¦‚æœå­˜åœ¨é‡å ï¼Œåˆ™è¿›è¡Œå¸ƒå°”è¿ç®—åˆå¹¶ã€‚

```ts
/**
 * åˆ›å»ºå¤šè¾¹å½¢
 * @param pointers 
 * @returns 
 */
export function createShape(pointers: Array<Point>) {
    const newShape = polybool.shape().beginPath()
    pointers.forEach((point, index) => {
        if (index === 0) {
            newShape.moveTo(point.x, point.y)
        } else {
            newShape.lineTo(point.x, point.y)
        }
    })
    newShape.closePath()
    return newShape
}


export function createExistingShape(polygons: StashPolygon[]) {
    const existingShape = polybool.shape().beginPath()
    polygons.forEach(polygon => {
        polygon.points.forEach((point, index) => {
            if (index === 0) {
                existingShape.moveTo(point.x, point.y)
            } else {
                existingShape.lineTo(point.x, point.y)
            }
        })
        existingShape.closePath()
    })
    return existingShape
}


/**
 * é¢„å…ˆå¤„ç†å¤šè¾¹å½¢
 * @param this 
 * @param newPointers 
 */
export function polygonUnion(this:Stash, newPointers: StashPolygon) {
    const pointers = this.polygons
    const newPolygon = polygonUnionHandler(pointers, newPointers)
    this.polygons = [...pointers, {
        ...newPointers,
        points: newPolygon,
    }]
}

export function polygonUnionHandler(pointers: StashPolygon[], newPointers: StashPolygon) {
    const newShape = createShape(newPointers.points)

    if (pointers.length === 0) {
        const receiver = new Receiver()
        const resultPaths = newShape.output(receiver).done()
        return resultPaths[0]
    }

    const existingShape = createExistingShape(pointers)

    const intersection = existingShape.combine(newShape).intersect()
    
    const result = newShape.combine(intersection).difference()

    const receiver = new Receiver()
    const resultPaths = result.output(receiver).done()
    return resultPaths[0]
}
```

- åˆ›å»ºå¤šè¾¹å½¢ï¼ˆcreateShapeã€createExistingShapeï¼‰ã€‚
- æ‰§è¡Œå¸ƒå°”è¿ç®—ï¼ˆpolygonUnionHandlerï¼‰ã€‚
- åˆå¹¶åˆ°å·²æœ‰å¤šè¾¹å½¢åˆ—è¡¨ï¼ˆpolygonUnionï¼‰ã€‚

ç»´æŠ¤ä¸€ä¸ªå¤šè¾¹å½¢åˆ—è¡¨ï¼Œå¹¶å…è®¸åŠ¨æ€åˆå¹¶æ–°å¤šè¾¹å½¢ï¼Œé¿å…é‡å åŒºåŸŸã€‚
ä¾èµ– polybool è¿›è¡Œå¸ƒå°”è¿ç®—ï¼Œæ ¸å¿ƒæ€è·¯æ˜¯å…ˆè®¡ç®—äº¤é›†ï¼Œå†å»æ‰äº¤é›†éƒ¨åˆ†ï¼Œé¿å…é‡å¤åˆå¹¶ï¼Œä»è€Œå®ç°åˆå¹¶ä¸é‡å çš„æ–°å½¢çŠ¶ã€‚


> å¯¹äºåœ¨ä¿®æ”¹å¤šè¾¹å‹æ—¶æ‰§è¡Œå¸ƒå°”è¿ç®—æ—¶ï¼Œéœ€è¦æ ¹æ®è°ƒæ•´åçš„å¤šè¾¹å‹ä¸å·²ç»å­˜åœ¨çš„å¤šè¾¹å‹è¿›è¡Œå¸ƒå°”è¿ç®—ï¼Œä»è€Œå®ç°åˆå¹¶ä¸é‡å çš„æ–°å½¢çŠ¶ã€‚

æœ€åçœ‹ä¸‹æ•´ä½“è®¾è®¡æ¶æ„å›¾ï¼š

![å¤šè¾¹å‹å·¥å…·æ¶æ„å›¾](https://cdn.overdev.cn/polygonUtil.png)

---


*å‚è€ƒèµ„æºï¼š*
- [Fabric.jså®˜æ–¹æ–‡æ¡£](https://fabricjs.com)
- [Polybool.js å¤šè¾¹å½¢å¸ƒå°”è¿ç®—åº“](https://github.com/velipso/polybool)