---
title: monorepoå·¥ç¨‹åŒ–å®è·µ - è„šæ‰‹æ¶å¼€å‘
date: 2023-03-30
description: Monorepoæ˜¯ä¸€ç§åœ¨å•ä¸ªç‰ˆæœ¬æ§åˆ¶åº“ä¸­ç®¡ç†å¤šä¸ªé¡¹ç›®çš„æ–¹æ³•ï¼Œå¯ç®€åŒ–ä»£ç å…±äº«å’Œä¾èµ–ç®¡ç†ï¼Œæé«˜å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡ã€‚æœ¬æ–‡è®°å½•monorepoçš„å·¥ç¨‹åŒ–å®è·µ
---
### èƒŒæ™¯
å› å½“ä¸‹åœºæ™¯éœ€è¦å¿«é€Ÿåˆ›å»ºé¡¹ç›®ï¼Œç›®å‰å‚è€ƒäº†`vite`ã€`astro`ç­‰è„šæ‰‹æ¶çš„å·¥ç¨‹åŒ–å®è·µï¼Œè®°å½•ä¸‹æœ¬æ¬¡monorepoå·¥ç¨‹åŒ–å®è·µã€‚åºŸè¯ä¸å¤šè¯´ä¸‹é¢å¼€å§‹ğŸ‘‡

### monorepoé¡¹ç›®æ­å»º
æœ‰å…³äºä»€ä¹ˆæ˜¯`monorepo`è¿™é‡Œä¸è¿‡å¤šèµ˜è¿°ï¼Œæœ‰å…´è¶£å¯ä»¥ç‚¹å‡»[åšå®¢](https://semaphoreci.com/blog/what-is-monorepo)æŸ¥çœ‹ï¼Œæˆ‘ä¸ªäººæ¨èä½¿ç”¨`pnpm`ä½œä¸ºåŒ…ç®¡ç†å·¥å…·ï¼Œå› ä¸º`pnpm`çš„ç‰¹æ€§å¯ä»¥å¾ˆå¥½çš„è§£å†³`monorepo`çš„ä¾èµ–ç®¡ç†é—®é¢˜ï¼Œè¿™é‡Œä¸è¿‡å¤šèµ˜è¿°ï¼Œæœ‰å…´è¶£å¯ä»¥ç‚¹å‡»[åšå®¢](https://www.pnpm.io/monorepos)æŸ¥çœ‹ã€‚

æˆ‘ä¸ªäººæ¨èä½¿ç”¨`pnpm`åˆ›å»ºé¡¹ç›®ï¼Œç›¸å…³ç»†èŠ‚è¯·ç§»æ­¥[pnpm monorepo](https://pnpm.io/zh/workspaces)æŸ¥çœ‹ã€‚

### åˆå§‹åŒ–é¡¹ç›®
```bash
mkdir terky
cd terky
pnpm init
```
> æ–°å»º`pnpm-workspace.yaml`æ–‡ä»¶ï¼Œé…ç½®`packages`ç›®å½•ä¸‹çš„æ‰€æœ‰åŒ…
```yaml
packages:
  - 'packages/*'
```
å› ä¸ºè¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ªè„šæ‰‹æ¶ï¼Œæ‰€ä»¥ä¸ä»…è¦æœ‰è„šæ‰‹æ¶åŒ…ï¼Œè¿˜è¦æœ‰æ¨¡æ¿åŒ…,è¿™æ˜¯æˆ‘çš„é¡¹ç›®ç›®å½•ç»“æ„
```plantuml
â”œâ”€packages
â”‚  â”œâ”€create-terky
â”‚     â”œâ”€template-vue3-ts
â”‚     â”œâ”€template-vue3
â”‚     â”œâ”€src

```

### `eslint`
> æ­¤é…ç½®ä½œä¸ºåŸºç¡€é…ç½®ï¼Œä¼šè¢«`packages`ä¸‹çš„åŒ…ç»§æ‰¿
- eslint
`eslint`æ ¸å¿ƒåŒ…
- @typescript-eslint/parser
`eslint`è§£æå™¨ï¼Œç”¨äºè§£æ`typescript`ä»£ç 
- @typescript-eslint/eslint-plugin
`eslint`æ’ä»¶ï¼Œç”¨äºæ£€æŸ¥`typescript`ä»£ç 
```bash
pnpm add eslint -D -w
pnpm add @typescript-eslint/parser -D -w
pnpm add @typescript-eslint/eslint-plugin -D -w
```
> æ–°å»º`.eslintrc.json`æ–‡ä»¶ï¼Œé…ç½®`eslint`
```json
{
  "parser": "@typescript-eslint/parser",
  "env": {
    "es6": true
  },
  "extends": [
      "eslint:recommended",
      "plugin:@typescript-eslint/recommended"
  ],
  "parserOptions": {
    "sourceType": "module",
    "ecmaVersion": 2021
  },
  "rules": {

  }
}
```

### `commitè§„èŒƒ`

é¦–å…ˆå…¨å±€å®‰è£… `commitizen`ï¼Œè¿™æ ·å¯ä»¥åœ¨æœ¬åœ°ä½¿ç”¨`cz`æˆ–`git cz`æ›¿ä»£`git commit`
```bash
pnpm add -g commitizen
```
ç›®å‰æœ‰å¾ˆå¤š`commit`å·¥å…·å¸®åŠ©æˆ‘ä»¬è¿›è¡Œè§„èŒƒåŒ–`commit`æ ¼å¼ï¼Œå…³äº`commit`è§„èŒƒä½ å¯ä»¥ç‚¹å‡»è¿™é‡Œ[æŸ¥çœ‹](https://www.ruanyifeng.com/blog/2016/01/commit_message_change_log.html)
æ¨èä½¿ç”¨`cz-git`ï¼Œå®˜æ–¹æä¾›äº†`commit`è§„èŒƒæ¨¡ç‰ˆï¼Œä»¥åŠæ”¯æŒ`emoji`ã€ä¸­æ–‡è‹±æ–‡åŒè¯­ï¼Œè€Œä¸”å®˜ç½‘ä¹Ÿæ˜¯ä¸­æ–‡æè¿°
```bash
pnpm add cz-git -D -w
```
å…·ä½“å¦‚ä½•é…ç½®ï¼Œè¯·ç§»æ­¥å®˜ç½‘æ–‡æ¡£æŸ¥çœ‹ï¼Œå†™çš„å¾ˆæ¸…æ¥šï¼Œå¯ä»¥ç›´æ¥é€‰æ‹©å–œæ¬¢çš„é…ç½®æ¨¡ç‰ˆç›´æ¥ä½¿ç”¨ï¼Œå»ºè®®æ­é…`commitlint`ä½¿ç”¨ã€‚å®‰è£…å®Œæˆåå‘`.commitlintrc.js`æ·»åŠ æ£€æµ‹è§„åˆ™
```json
{
  ...
  extends: ['@commitlint/config-conventional']
  ...
}
```
æ·»åŠ `scripts`è„šæœ¬å‘½ä»¤
```json
{
  "scripts": {
    "commitlint": "commitlint --config .commitlintrc.js -e -V"
  }
}
```
`commitlint`éœ€è¦æ­é…`husky`ï¼Œéœ€è¦æ·»åŠ commit-msg hooks
```bash
pnpm add husky @commitlint/{config-conventional,cli} -D -w
husky install
npx husky add .husky/commit-msg 'npm run commitlint'
```
## create-terky

`terky`æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„è„šæ‰‹æ¶ï¼Œé€šè¿‡ä½¿ç”¨`npm create terky`å¯ä»¥å¿«é€Ÿä»`github`çš„æ¨¡ç‰ˆåˆ—è¡¨ä¸­æ‹‰å–æˆ‘ä»¬æ‰€éœ€è¦çš„é¡¹ç›®åŸºç¡€æ¨¡ç‰ˆï¼Œçœå»é‡å¤çš„`webpack`é…ç½®
å’Œä¸€èµ·å…¶ä»–çš„é¡¹ç›®é…ç½®

* `npm create <package>` æ˜¯ä»€ä¹ˆ?

ä¸€èˆ¬åœ¨åˆå§‹åŒ–é¡¹ç›®çš„æ—¶å€™ï¼Œéƒ½ä¼šå»æ‰§è¡Œ`npm init`ï¼Œä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆä¸€ä¸ª`package.json`æ–‡ä»¶ï¼Œåœ¨`init`åé¢è¿˜å¯ä»¥è·Ÿä¸€ä¸ªå‚æ•°`<initializer>`,
å½“å¢åŠ ä¸Šè¿™ä¸ªå‚æ•°æ—¶ï¼Œ`npm`ä¼šå»æŸ¥è¯¢åä¸º`create-<initializer>`è¿™ä¸ªåŒ…ï¼Œå¦‚æœæœ¬åœ°å­˜åœ¨é‚£ä¹ˆå°±æ‰§è¡Œæœ¬åœ°ç¼“å­˜ï¼Œåä¹‹åˆ™åŒæ­¥è¿œç¨‹åŒ…åˆ°æœ¬åœ°æ‰§è¡Œã€‚ä½¿ç”¨
`npm exec`æ‰§è¡Œ`create-<initializer>`åŒ…çš„`bin`ä¸‹å®šä¹‰çš„å‘½ä»¤`create-<initializer>`ï¼Œ`bin`æ˜¯åœ¨`package.json`ä¸­å®šä¹‰çš„ã€‚
`npm v6`ç‰ˆæœ¬ç»™`init`å‘½ä»¤å¢åŠ äº†ä¸€ä¸ªåˆ«å`create`ï¼Œæ‰€ä»¥ `init`ç­‰äº`create`ï¼Œè¯¦ç»†ä¿¡æ¯å¯ä»¥ç‚¹å‡»[è¿™é‡Œ](https://docs.npmjs.com/cli/v9/commands/npm-init)æŸ¥çœ‹

### å®æˆ˜
é¦–å…ˆéœ€è¦åœ¨æœ¬åœ°åˆå§‹åŒ–ä¸€ä¸ª`package.json`ï¼Œå¹¶å®‰è£…æ‰€éœ€ä¾èµ–
```bash
pnpm init

pnpm add -D typescript
pnpm add -D unbuild
pnpm add prompts
pnpm add ora
pnpm add kolorist
pnpm add fs-extra
pnpm add execa
pnpm add minimist
```
- typescript æˆ‘ä½¿ç”¨`typescript`ç¼–å†™é¡¹ç›®
- unbuild æ‰“åŒ…`typescript`ä»£ç 
- prompts ç»™ç”¨æˆ·æä¾›äº¤äº’å¼é€‰æ‹©
- ora å¯ä»¥åœ¨æ§åˆ¶å°ä½¿ç”¨loadingåŠ¨ç”»
- kolorist ä¿®æ”¹æ§åˆ¶å°ä¸­è¾“å‡ºçš„æ–‡å­—çš„é¢œè‰²
- fs-extra åŸºäº`fs`æ¨¡å—æ›´å¥½çš„æ–‡ä»¶æ“ä½œAPI
- execa åœ¨`nodejs`ä¸­æ‰§è¡Œå‘½ä»¤
- minimist è§£æä¼ å…¥çš„å‚æ•°

ä½¿ç”¨`tsc --init`åˆå§‹åŒ–`tsconfig.json`

```json
{
  "include": ["build.config.ts","src"],
  "compilerOptions": {
    "outDir": "dist",
    "target": "ES2020",
    "module": "ES2020",
    "moduleResolution": "bundler",
    "strict": true,
    "skipLibCheck": true,
    "declaration": false,
    "sourceMap": false,
    "noUnusedLocals": true,
    "esModuleInterop": true,
    "noEmit": true,
    "allowImportingTsExtensions": true
  }
}

```
åˆ›å»º`build.config.ts`æä¾›`unbuild`æ‰“åŒ…é…ç½®ï¼Œå¹¶åœ¨`package.json`ä¸­å¢åŠ å‘½ä»¤
```ts
import { defineBuildConfig } from 'unbuild'
export default defineBuildConfig({
    entries: ['src/index.ts'],
    clean: true,
    rollup: {
        inlineDependencies: true,
        esbuild: {
            minify: true,
        },
    },
})
```
```json
{
  ...
  "script": {
    "build": "unbuild"
  },
  ...
}
```

æ–°å»º`index.js`æä¾›ç¨‹åºä¸»å…¥å£
```js
#!/usr/bin/env node
import "./dist/index.mjs"
```
srcç›®å½•ç»“æ„å¦‚ä¸‹
```
â”œâ”€src
|  â”œâ”€index.ts 
|  â”œâ”€utils.ts 
|  â”œâ”€actions 
|     â”œâ”€utils.ts 
```

- utils.ts

> åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­éœ€è¦æä¾›ä¸€äº›å·¥å…·å‡½æ•°åŠé—®ç­”äº¤äº’ï¼Œæœ‰å…³[`prompts`](https://github.com/terkelg/prompts)çš„ç”¨æ³•è¯·ç§»æ­¥æ–‡æ¡£æŸ¥çœ‹
```ts
import { blue, yellow } from 'kolorist'
import fs from  'fs'
// é»˜è®¤é¡¹ç›®åç§°
export const defaultDir = 'terky-app'
// é—®ç­”äº¤äº’
export const FRAMEWORKS = [
  {
    name: 'vue3',
    display: 'JavaScript',
    color: yellow,
    value: 'template-vue3'
  },
  {
    name: 'vue3-ts',
    display: 'TypeScript',
    color: blue,
    value: 'template-vue3-ts'
  },
]
// åˆ¤æ–­ç›®å½•æ˜¯å¦å­˜åœ¨
export const isEmpty = (dir: string) => fs.existsSync(dir)
// åˆ›å»ºé¡¹ç›®ç›®å½•
export const mkdirSync = (dir: string) => fs.mkdirSync(dir)
```

- git.ts
> åœ¨è¿™ä¸ªå‡½æ•°ä¸­å…¶å®åªåšäº†ä¸€ä»¶äº‹ï¼Œé‚£å°±æ˜¯å°†ç”¨æˆ·æ‰€é€‰æ‹©çš„æ¨¡ç‰ˆä¸‹è½½åˆ°æœ¬åœ°
```ts
import path, { dirname } from "path";
import { fileURLToPath } from 'url';
import { execa } from 'execa'
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
export const createRepo = async (targetDir: string, template: string) => {
  const filePath = path.join(__dirname, `../${template}`)
  await execa('cp', ['-r',filePath, targetDir])
}
```

- index.ts
> è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªä¸»å…¥å£ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬æ‰“åŒ…çš„å…¥å£ï¼Œæ‰§è¡Œå‘½ä»¤å…¶å®å°±æ˜¯ç›¸å½“äºæ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ä¸­çš„`main`å‡½æ•°

1.é¦–å…ˆæ ¹æ®`utils`ä¸­å®šä¹‰çš„é—®ç­”åˆ—è¡¨ï¼Œå‘ç”¨æˆ·æé—®ğŸ™‹ã€‚
2.æ ¹æ®ç”¨æˆ·è¾“å…¥å’Œé€‰æ‹©çš„å†…å®¹åˆ¤æ–­ç›®å½•æ˜¯å¦å­˜åœ¨
  a.å¦‚æœå­˜åœ¨é‚£ä¹ˆé€€å‡ºç¨‹åºï¼Œæç¤ºç”¨æˆ·ç›®å½•å·²ç»å­˜åœ¨
  b.ä¸å­˜åœ¨ç›®å½•é‚£ä¹ˆæ–°å»ºç›®å½•
3.æ‰§è¡Œ`git`ä¸­æ‰€æä¾›`createRepo`å‡½æ•°ï¼Œåˆå§‹åŒ–ç›®å½•å¹¶æ‹‰å–æ¨¡ç‰ˆä»£ç 
```ts
import { defaultDir, FRAMEWORKS, isEmpty, mkdirSync} from './utils.ts'
import { createRepo } from './actions/git.ts'
import { red, reset,  } from 'kolorist'
import prompts from 'prompts'
import path from "path"
import ora from 'ora'
async function main () {
  const result = await prompts([
    {
      type: 'text',
      name: 'projectName',
      message: reset('ğŸ‘‰ é¡¹ç›®åç§° | Project name:'),
      initial: defaultDir
    },
    {
      type: 'select',
      name: 'template',
      message: reset('ğŸ‘‰ é€‰æ‹©æ¨¡æ¿ | Select template:'),
      choices: FRAMEWORKS.map((framework) => ({
          title: framework.color(framework.name),
          value: framework.value,
      }))
    }
  ], {
    onCancel: () => {
      console.log(red('âœ–') + 'æ“ä½œè¢«å–æ¶ˆ | Operation canceled')
    }
  })
  const spinner = ora('æ­£åœ¨åˆ›å»ºé¡¹ç›® | Creating project...').start()
  const { projectName, template } = result
  const root = path.join(process.cwd(), projectName)
  if (isEmpty(root)) {
    console.log(red('âœ–') + `ç›®å½•å·²å­˜åœ¨ | Directory already exists: /${projectName}`)
    ora().fail('åˆ›å»ºå¤±è´¥ | Create failed')
    spinner.stop()
    return
  }
  spinner.text = 'æ­£åœ¨åˆ›å»ºç›®å½• | Creating directory...'
  await mkdirSync(projectName)
  await createRepo(root, template, spinner)
  spinner.succeed('åˆ›å»ºæˆåŠŸ | Create success')
}

main().catch((err) => {
  console.error(err)
  process.exit(1)
})

```

### æœ¬åœ°æµ‹è¯•
è¿˜è®°å¾—å‰é¢æ‰€æåˆ°`npm create`çš„åŸç†å—ï¼Œç°åœ¨éœ€è¦å‘`package.json`ä¸­æ·»åŠ `bin`å­—æ®µ
```json {3-5}
{
  ...
  "bin": {
    "create-terky": "index.js"
  },
  "scripts": {
    "build": "unbuild"
  }
}
```
ç°åœ¨æˆ‘ä»¬å¯ä»¥æ‰§è¡Œ`pnpm build`ï¼Œç”Ÿæˆ`dist/index.mjs`ï¼Œå› ä¸ºæˆ‘ä»¬ä¸»å…¥å£æ–‡ä»¶éœ€è¦å®ƒ
```js {2}
#!/usr/bin/env node
import "./dist/index.mjs"
```

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œæˆ‘ä»¬éœ€è¦åœ¨å½“å‰ç›®å½•æ‰§è¡Œ`npm link`ï¼Œå°†æ­¤åŒ…é“¾æ¥åˆ°å…¨å±€å°±å¯ä»¥ç›´æ¥ä½¿ç”¨`bin`ä¸‹å®šä¹‰çš„å‘½ä»¤`create-terky`


### å‘å¸ƒ

æœ¬åœ°æµ‹è¯•å®Œæˆä¹‹åå°±å¯ä»¥å‘å¸ƒåˆ°`npm`ï¼Œåœ¨å‘å¸ƒä¹‹å‰æ‚¨éœ€è¦å…ˆæ‹¥æœ‰ä¸€ä¸ª`npm`è´¦å·ï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œ[æ³¨å†Œ](https://www.npmjs.com/signup)ã€‚å¦‚æœæ‚¨å·²ç»æ‹¥æœ‰è´¦å·ï¼Œ
æ‚¨å¯ä»¥å¿½ç•¥ä¸Šä¸€æ­¥ã€‚ç°åœ¨è¿˜éœ€è¦åœ¨æœ¬åœ°æ–°å»ºä¸€ä¸ªåä¸º`.npmrc`çš„æ–‡ä»¶ï¼Œå¹¶å†™å…¥å†…å®¹
```rc
registry=https://registry.npmjs.org/
```
è¿™ä¸ªæ–‡ä»¶å¯ä»¥è®©æˆ‘ä»¬åœ¨å½“å‰é¡¹ç›®çš„ç›®å½•ä¸‹æ‰§è¡Œ`npm login`æ—¶ï¼Œæ€»æ˜¯ç™»å½•åˆ°å…¬å…±çš„`npm`ã€‚è¿™æ ·å¯ä»¥é¿å…æ‚¨ç™»å½•åˆ°å¯èƒ½æ­£åœ¨ä½¿ç”¨æ‚¨è‡ªå·±çš„ç»„ç»‡å†…éƒ¨çš„ç§æœ‰`npm`æœåŠ¡ã€‚

ç°åœ¨å‡†å¤‡å·¥ä½œå·²ç»å®Œæ¯•ï¼Œå¼€å§‹å§

```bash
npm login
```
> åœ¨å‘å¸ƒä¹‹å‰è¯·æ‚¨ç¡®ä¿æ‚¨çš„`package.json`ä¸­çš„`name`å­—æ®µåœ¨`npm`ä¸­æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œé¿å…ä¸å…¶ä»–æ¨¡å—å†²çª

```bash
npm public
```

å¦‚æœæ²¡æœ‰å‡ºç°`error`æç¤ºï¼Œé‚£ä¹ˆæ‚¨å°±å¯ä»¥ç™»å½•`npm`ï¼Œæœç´¢è‡ªå·±çš„åŒ…åäº†ã€‚å½“ç„¶æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥å°è¯•`npm create terky`æ¥ä½¿ç”¨æˆ‘æ‰€å‘å¸ƒçš„å·¥å…·ã€‚

å®Œæˆä»£ç å¯ä»¥ç‚¹å‡»[æŸ¥çœ‹](https://github.com/overdev-l/terky)ï¼Œæ‚¨ä¹Ÿä¼šæœ‰å¥½çš„æƒ³æ³•æˆ–è€…æ¨¡ç‰ˆï¼Œ
æ‚¨å¯ä»¥æäº¤PRæˆ–å‘é€é‚®ä»¶è‡³[`<yz@overdev.cn>`](mailto:yz@overdev.cn)ï¼Œæˆ‘ä¼šå°½å¿«å›å¤æ‚¨ğŸ¦€ï¸ğŸ¦€ï¸ã€‚

åœ¨ä¸‹é¢æ‚¨å¯ä»¥çœ‹åˆ°ä¸€äº›å¯¹æ‚¨æœ‰ç”¨çš„é“¾æ¥ğŸ‘‡

- [`monorepo`æ˜¯ä»€ä¹ˆï¼Ÿ](https://semaphoreci.com/blog/what-is-monorepo)
- [`workspace`æ˜¯ä»€ä¹ˆï¼Ÿ](https://pnpm.io/zh/workspaces)
- [`commit message`æ˜¯ä»€ä¹ˆï¼Ÿ](https://www.ruanyifeng.com/blog/2016/01/commit_message_change_log.html)
- [`prompts`æ˜¯ä»€ä¹ˆï¼Ÿ](https://chinabigpan.github.io/prompts_docs_cn/)
- [`.npmrc`æ˜¯ä»€ä¹ˆï¼Ÿ](https://docs.npmjs.com/cli/v7/configuring-npm/npmrc)
- [`npm link`æ˜¯ä»€ä¹ˆï¼Ÿ](https://docs.npmjs.com/cli/v9/commands/npm-link?v=true)